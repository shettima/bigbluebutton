<?xml version="1.0" encoding="utf-8"?>
<MDIWindow xmlns="flexlib.mdi.containers.*" 
	       xmlns:mx="http://www.adobe.com/2006/mxml" 
	       showCloseButton="false" height="520" width="550">

	<mx:Script>
		<![CDATA[
			
			import org.bigbluebutton.modules.desktopshare.model.vo.ImageVO;
			import org.bigbluebutton.modules.desktopshare.model.vo.*;
			import org.bigbluebutton.modules.desktopshare.view.DesktopShareWindowMediator;
			import mx.core.UIComponent;
			import flash.external.ExternalInterface;
		    import mx.controls.SWFLoader;
        	import mx.utils.Base64Decoder;
        	import flash.net.FileReference;
        	import org.bigbluebutton.modules.log.LogModuleFacade;

			public static const TITLE:String = "Desktop Share";
			public var timer:Timer;
			public var im:ImageVO = new ImageVO("");
			public var base64Decoder:Base64Decoder = new Base64Decoder();
			private var ratio:Number;
			public var canvas:Canvas;
			private var tileH:Number;
			private var tileW:Number;
			private var log : LogModuleFacade = LogModuleFacade.getInstance("LogModule");
		
			public function startShare():void
		    {
		    	//this.timer = new Timer(1500,0);
		    	//this.timer.addEventListener(TimerEvent.TIMER , sendImage);
		    	//this.timer.start();
		    	//ExternalInterface.call("addFrame");
		    	this.share_Btn.enabled = false;
		    	this.unshare_Btn.enabled = true;
		    	//ratio = ExternalInterface.call("getResJS1");
		    	//trace(ratio);
		    	
		    }
			
			public function stopShare():void
			{
				//this.timer.removeEventListener(TimerEvent.TIMER , sendImage);
				//this.timer.stop();
				this.share_Btn.enabled = true;
				this.unshare_Btn.enabled = false;
			}
			
			public function sendImage(e:TimerEvent):void
			{
				var s:String = ExternalInterface.call("getStringJS");
				//trace(s);
				im.imageString = s;
				dispatchEvent(new Event(DesktopShareWindowMediator.NEW_IMAGE));
			}
			
			public function showNewImage(imagevo:ImageVO):void
			{
				//if(preview_box.getChildByName("preview"))
				//preview_box.removeChild(preview_box.getChildByName("preview"));
				
                tileH = imagevo.tileheight;
                tileW = imagevo.tilewidth;
            	var imageArray:Array = imagevo.stringArray;
            	
            	for(var i:int =0 ; i<6 ; i++)
            	{
            		for(var j:int=0; j<6 ; j++)
            		{
            			
            			//if(imagevo.stringArray[i][j].length > 20){
            			trace(imagevo.tileheight+"  "+imagevo.tilewidth);
            			//trace("stringArray["+i+"]["+j+"].length: "+imageArray[i][j]+"\n");
            			if(preview_box.getChildByName("preview"+i+""+j))
                		preview_box.removeChild(preview_box.getChildByName("preview"+i+""+j));
                		base64Decoder.reset();
                		base64Decoder.decode(imagevo.stringArray[i][j]);
                		trace("Decoded.");
						var ba:ByteArray = base64Decoder.drain();
						trace("Drained.");
						trace("ba.length: " + ba.length+"\n");
						var ui_loader: UIComponent = new UIComponent();
						var ldr:Loader = new Loader();
                        ldr.loadBytes(ba);
                        trace("Loaded.");
                        ui_loader.addChild(ldr);
                        canvas = new Canvas();
						canvas.name = "preview"+i+""+j;
						canvas.addChildAt(ui_loader,0);
						canvas.scaleX = hSlider.value/100;
						canvas.scaleY = hSlider.value/100;
						canvas.x = i * tileW * hSlider.value/100;
						canvas.y = j * tileH * hSlider.value/100;
						//canvas.x = i*imagevo.tilewidth;//canvas.width;//(hSlider.value/100);
                      	//canvas.y = j*imagevo.tileheight;//canvas.height;//(hSlider.value/100);
                   		preview_box.addChildAt(canvas, 0);
             //  }
              // else{return;}
                   		
                		
            		}
            	}
            	
            //	return;
 /*         	
            	
            	var i:Number = imagevo.row;
            	var j:Number = imagevo.column;
            	var image:String = imagevo.imageString;
            	//trace("i: "+i+","+"j: "+j+"\n");
            	if( ((i!=0) && (i!=1) && (i!=2) && (i!=3) && (i!=4) && (i!=5)) ||
            	((j!=0) && (j!=1) && (j!=2) && (j!=3) && (j!=4) && (j!=5)))
            	{
            		return;	
            	}    
            	if(preview_box.getChildByName("preview"+i+""+j))
                preview_box.removeChild(preview_box.getChildByName("preview"+i+""+j));
                
                base64Decoder.reset();
                base64Decoder.decode(image);
				var ba:ByteArray = base64Decoder.drain();
				var ui_loader: UIComponent = new UIComponent();
				
				canvas.name = "preview"+i+""+j;
				var ldr:Loader = new Loader();
                ldr.loadBytes(ba);
                ui_loader.addChild(ldr);
                canvas.addChildAt(ui_loader, 0);
*/			
				
//				var ldr:Loader = new Loader();
//                ldr.loadBytes(ba);
//                ui_loader.addChild(ldr);
//                canvas.addChildAt(ui_loader, 0);
                //ui_loader.scaleX = 0.6;
                //ui_loader.scaleY = 0.6;
                //canvas.scaleX = preview_box.height * 0.0008;
                //canvas.scaleY = preview_box.height * 0.0008;// * 0.8;
                
                
                //ui_loader.scaleX = preview_box.width * 0.001;
                //ui_loader.scaleY = preview_box.width * 0.001 * 0.8;
                //ldr.x = preview_box.width/6 * i;
                //ldr.y = preview_box.height/6 * j;
              
//                canvas.x = i* (preview_box.width/6);
//                if (j == 5)
//                canvas.y = 0;
//                else canvas.y = (j+1) * preview_box.height/6;
//                trace(canvas.width + "," + canvas.height);
                
                
                //trace("x: "+ldr.x+" y: "+ldr.y+"\n");
//                preview_box.addChildAt(canvas, 0);
                //canvas.addChildAt(ui_loader, 0);
                //trace("ui_loader.screen.height : " + ui_loader.screen.height);
                //trace("preview_box.height: "+preview_box.height+"\n"+"preview_box.parent.height: "+preview_box.parent.height+"\n");
//                return;
             
			}
			public function changeSize():void
			{
				for(var i:int =0 ; i<6 ; i++)
            	{
            		for(var j:int=0; j<6 ; j++)
            		{
						preview_box.getChildByName("preview"+i+""+j).scaleX = hSlider.value/100;
						preview_box.getChildByName("preview"+i+""+j).scaleY = hSlider.value/100;
						preview_box.getChildByName("preview"+i+""+j).x = i * tileW * hSlider.value/100;
						preview_box.getChildByName("preview"+i+""+j).y = j * tileH * hSlider.value/100;
            		}
            	}
				//canvas.scaleX = hSlider.value/100;
				//trace("canvas.width = " + canvas.width);
                //canvas.scaleY = hSlider.value/100;
                //trace("canvas.height = " + canvas.height);
			}
			
			public function download():void
			{		
            	ExternalInterface.call("addFrame");
            	//var request:URLRequest = new URLRequest("http://www.technoexpert.ca/flash/ScreenShot.jar");
				//navigateToURL(request,"_blank");
			}
			      

		]]>
	</mx:Script>
	
	<mx:Canvas id="preview_box" left="1" top="1" right="1" bottom="1" horizontalScrollPolicy="on" 
    	verticalScrollPolicy="on" width="100%" height="100%">
    	
    </mx:Canvas>
   <!-- <mx:TextArea id="strJS" width="570" height="100"/>
    <mx:TextArea id="strRed5" width="570" height="100"/>-->
    <mx:ApplicationControlBar>
    	<mx:Button id="share_Btn" label="Start Sharing" click="startShare()"/>
    	<mx:Button id="unshare_Btn" label="Stop Sharing" click="stopShare()"/>
    	<mx:Button id="dwn" label="Download" click="download()" enabled="false"/>
    	<mx:HSlider id="hSlider" minimum="0" maximum="100" value="100" 
            dataTipPlacement="bottom" 
            tickColor="black" 
            snapInterval="1" tickInterval="10" 
            labels="['0%','100%']" 
            allowTrackClick="true" 
            liveDragging="true"
            change="changeSize();"/>
    	<mx:Label id="wait" text="" fontWeight="bold"/>
   	</mx:ApplicationControlBar>
    
</MDIWindow>
