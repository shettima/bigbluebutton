<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xmlns:integration="http://www.springframework.org/schema/integration"
	xmlns:jms="http://www.springframework.org/schema/integration/jms"
	xmlns:file="http://www.springframework.org/schema/integration/file"
	xmlns:stream="http://www.springframework.org/schema/integration/stream"
	xsi:schemaLocation="http://www.springframework.org/schema/beans
			http://www.springframework.org/schema/beans/spring-beans-2.5.xsd
			http://www.springframework.org/schema/integration
			http://www.springframework.org/schema/integration/spring-integration-1.0.xsd
			http://www.springframework.org/schema/integration/jms
			http://www.springframework.org/schema/integration/jms/spring-integration-jms-1.0.xsd
			http://www.springframework.org/schema/integration/stream
			http://www.springframework.org/schema/integration/stream/spring-integration-stream-1.0.xsd
			http://www.springframework.org/schema/integration/file
			http://www.springframework.org/schema/integration/file/spring-integration-file-1.0.xsd
			">

	
	
   <bean class="org.asteriskjava.fastagi.AgiServerThread"
      init-method="startup" destroy-method="shutdown">
      <property name="agiServer" ref="agiServer"/>
   </bean>   
   
   <bean id="agiServer" class="org.asteriskjava.fastagi.DefaultAgiServer">
      <property name="bindPort" value="4573"/>
      <property name="mappingStrategy" ref="mappingStrategy" />
   </bean>
   
	<bean id="mappingStrategy" class="org.asteriskjava.fastagi.SimpleMappingStrategy">
		<property name="mappings">
			<map>
				<entry key="meetme.groovy" value-ref="asteriskAgi" />
				<entry key="findConference" value-ref="asteriskAgi" />
			</map>
		</property>
	</bean>
			
	<bean id="asteriskAgi" class="org.bigbluebutton.pbx.asterisk.AsteriskAgiService" />
	
	<bean id="test123" class="org.bigbluebutton.presentation.imp.Testing123" />
	
	<!-- Spring Integration / JMS gateways -->
    <bean id="connectionFactory" class="org.apache.activemq.ActiveMQConnectionFactory">
        <property name="brokerURL">
            <value>tcp://localhost:61616</value>
        </property>
    </bean>

	<jms:inbound-channel-adapter id="jmsInConferenceStarted"
		destination-name="conferenceStartedEvents"
        channel="conferenceStarted"
        extract-payload="true">
		<integration:poller>
			<integration:interval-trigger interval="5" time-unit="SECONDS"/>
		</integration:poller>
	</jms:inbound-channel-adapter>
	<jms:inbound-channel-adapter id="jmsInConferenceEnded"
		destination-name="conferenceEndedEvents"
        channel="conferenceEnded"
        extract-payload="true">
		<integration:poller>
			<integration:interval-trigger interval="5" time-unit="SECONDS"/>
		</integration:poller>
	</jms:inbound-channel-adapter>
 
	<integration:channel id="conferenceStarted"/>
	<integration:channel id="conferenceEnded"/>

	<integration:service-activator input-channel="conferenceStarted" ref="dynamicConferenceService" method="conferenceStarted" />
	<integration:service-activator input-channel="conferenceEnded" ref="dynamicConferenceService" method="conferenceEnded" />
	
<!--	<stream:stdout-channel-adapter id="stdout" channel="jmsinToStdoutChannel" append-newline="true"/>-->

	<!--import resource="doc-conversion.xml" /-->
	
	<integration:gateway id="documentConversionService" service-interface="org.bigbluebutton.presentation.DocumentConversionService"/>
	<integration:channel id="convertChannel"/>

	<integration:filter ref="supportedDocumentFilter" method="isSupported" input-channel="convertChannel" 
						output-channel="docRouterChannel"/>
	<bean id="supportedDocumentFilter" class="org.bigbluebutton.presentation.SupportedDocumentFilter">
		<property name="conversionProgressNotifier" ref="conversionProgressNotifier"/>
	</bean>
		
	<integration:channel id="docRouterChannel"/>	
	<integration:router ref="fileTypeRouter" input-channel="docRouterChannel"/>
	<bean id="fileTypeRouter" class="org.bigbluebutton.presentation.FileTypeRouter"/>
	
	<integration:channel id="officeFileChannel"/>
	<integration:channel id="pdfFileChannel"/>
	<integration:channel id="conversionProgressChannel"/>
	<integration:gateway id="conversionProgressNotifier" service-interface="org.bigbluebutton.presentation.ConversionProgressNotifier"/>
	
	<integration:service-activator input-channel="officeFileChannel" ref="officeToPdfConversionService" method="convertOfficeToPdf"/>
	<bean id="officeToPdfConversionService" class="org.bigbluebutton.presentation.imp.OfficeToPdfConversionService"/>
		
    <integration:service-activator input-channel="pdfFileChannel" ref="slidesGenerationService" method="generateSlides"/>
	<integration:channel id="discardChannel"/>
    
    
    <jms:outbound-channel-adapter id="jmsOut" destination-name="UpdatesQueue" channel="conversionProgressChannel"/>
        	
	<bean id="pageExtractor" class="org.bigbluebutton.presentation.imp.GhostscriptPageExtractor">
		<property name="ghostscriptExec" value="${ghostScriptExec}"/>
		<property name="noPdfMarkWorkaround" value="${noPdfMarkWorkaround}"/>
	</bean>
	
	<bean id="imageMagickPageConverter" class="org.bigbluebutton.presentation.imp.ImageMagickPageConverter">
		<property name="imageMagickDir" value="${imageMagickDir}"/>
	</bean>
		
	<bean id="png2SwfConverter" class="org.bigbluebutton.presentation.imp.Png2SwfPageConverter">
		<property name="swfToolsDir" value="${swfToolsDir}"/>
	</bean>
		
	<bean id="pageCounter" class="org.bigbluebutton.presentation.imp.Pdf2SwfPageCounter">
		<property name="swfToolsDir" value="${swfToolsDir}"/>
	</bean>
		
	<bean id="pageCounterService" class="org.bigbluebutton.presentation.imp.PageCounterService">
		<property name="pageCounter" ref="pageCounter"/>
	</bean>
	
	<bean id="pdf2SwfPageConverter" class="org.bigbluebutton.presentation.imp.Pdf2SwfPageConverter">
		<property name="swfToolsDir" value="${swfToolsDir}"/>
	</bean>
	
	<bean id="imageConvSvc" class="org.bigbluebutton.presentation.imp.PdfPageToImageConversionService">
		<property name="pageExtractor" ref="pageExtractor"/>
		<property name="pdfToImageConverter" ref="imageMagickPageConverter"/>
		<property name="imageToSwfConverter" ref="png2SwfConverter"/>
	</bean>
	
	<bean id="thumbCreator" class="org.bigbluebutton.presentation.imp.ThumbnailCreatorImp">
		<property name="imageMagickDir" value="${imageMagickDir}"/>
		<property name="blankThumbnail" value="${BLANK_THUMBNAIL}"/>
	</bean>
	
	<bean id="generatedSlidesInfoHelper" class="org.bigbluebutton.presentation.GeneratedSlidesInfoHelperImp"/>
	
	<bean id="slidesGenerationService" class="org.bigbluebutton.presentation.imp.PdfToSwfSlidesGenerationService">
		<property name="counterService" ref="pageCounterService"/>
		<property name="pageConverter" ref="pdf2SwfPageConverter"/>
		<property name="pdfPageToImageConversionService" ref="imageConvSvc"/>
		<property name="thumbnailCreator" ref="thumbCreator"/>
		<property name="blankSlide" value="${BLANK_SLIDE}"/>
		<property name="maxConversionTime" value="${maxConversionTime}"/>
		<property name="conversionProgressNotifier" ref="conversionProgressNotifier"/>
		<property name="generatedSlidesInfoHelper" ref="generatedSlidesInfoHelper"/>
	</bean>		

</beans>